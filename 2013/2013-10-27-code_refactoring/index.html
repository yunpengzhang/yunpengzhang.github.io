<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>谈一谈代码重构 | owenzhang的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="上周进行小组分享的时候讲的代码重构，从《代码大全》《clean code》《重构》三本书中摘抄了一些观点，结合日常开发的例子讲解了以下。发现重构不像工具学习，听了一节课马上就有效果，能解决一个问题，更多的还是要培养一种意识。在开发代码的时候不引入错误不健康的习惯，在维护代码的时候能够收住有味道的代码，不让项目变得更糟。 当然，做这种事不会有直接利益，不像查找个内存泄漏更容易让人佩服。但是好的编码习">
<meta property="og:type" content="article">
<meta property="og:title" content="谈一谈代码重构">
<meta property="og:url" content="https://yunpengzhang.github.io/2013/2013-10-27-code_refactoring/index.html">
<meta property="og:site_name" content="owenzhang的博客">
<meta property="og:description" content="上周进行小组分享的时候讲的代码重构，从《代码大全》《clean code》《重构》三本书中摘抄了一些观点，结合日常开发的例子讲解了以下。发现重构不像工具学习，听了一节课马上就有效果，能解决一个问题，更多的还是要培养一种意识。在开发代码的时候不引入错误不健康的习惯，在维护代码的时候能够收住有味道的代码，不让项目变得更糟。 当然，做这种事不会有直接利益，不像查找个内存泄漏更容易让人佩服。但是好的编码习">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2013-10-26T16:00:00.000Z">
<meta property="article:modified_time" content="2024-07-20T13:56:42.411Z">
<meta property="article:author" content="owenzhang">
<meta property="article:tag" content="后端,架构,读书,运动,写作">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="owenzhang的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">owenzhang的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一个程序员的成长之路</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://yunpengzhang.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2013/2013-10-27-code_refactoring" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2013/2013-10-27-code_refactoring/" class="article-date">
  <time class="dt-published" datetime="2013-10-26T16:00:00.000Z" itemprop="datePublished">2013-10-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      谈一谈代码重构
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>上周进行小组分享的时候讲的代码重构，从《代码大全》《clean code》《重构》三本书中摘抄了一些观点，结合日常开发的例子讲解了以下。发现重构不像工具学习，听了一节课马上就有效果，能解决一个问题，更多的还是要培养一种意识。在开发代码的时候不引入错误不健康的习惯，在维护代码的时候能够收住有味道的代码，不让项目变得更糟。</p>
<p>当然，做这种事不会有直接利益，不像查找个内存泄漏更容易让人佩服。但是好的编码习惯是自己终身的财富，就像一个彬彬有礼的人，平时可能会“吃亏”，但是最终会受益的。</p>
<p>##不要抱怨</p>
<blockquote>
<p>这段代码真烂！</p>
</blockquote>
<p>通常新维护别人的代码时都会发出感慨，然后加500字的嘲笑，或者和其他人讲述那个模块如何地令人恶心……<br>可是有用吗，代码还是那样，依旧在那里，该脏还是脏。</p>
<p>更好的方式应该是想“如何优化这段代码”，或者和另外一个小伙伴商量医治这段代码的手段。解决问题才是真，不要抱怨。<br>##什么是重构<br>重构不是重写！</p>
<p>重构还是要保持代码最开始的框架和功能，对外来说，黑盒的接口没有变化。对内来说，框架还是最初的框架。目的还是让代码更容易维护。</p>
<p>不要把重构当作重写的接口，不要在刚写软件的时候就想以后会重构。修改软件的最好时机就是在他被初创的时候，一旦对外发布，在想改变，就要测试、评估，代价越往后越高。而且“do it later &#x3D; do it never”<br>##重构的优先级<br>从简单到复杂。先修改简单的，对主逻辑影响小或干脆没影响的，测试压力会小一些；然后修改逻辑重的部分，最后再修改核心算法。一次只修改一个地方，方便观察和回溯。<br>##重构的理由</p>
<ul>
<li>代码重复</li>
<li>代码冗长</li>
<li>参数太多</li>
<li>使用全局变量</li>
<li>过渡设计</li>
<li>……</li>
</ul>
<p>见过最多的就是代码重复，冗长。一个文件上万行，代码逻辑比较简单，增加逻辑就添加个if分支，表面上是省事了，但是给扩展性增加了困难。</p>
<p>总之就是代码有味道。发现可以精简，做得更好的地方，在修复bug，增加子程序时顺手给处理掉。“让营地比来的时候更干净”。<br>##具体的重构方法</p>
<ul>
<li>用具名常量代替魔数。</li>
<li>将一组类型码转换为类或枚举</li>
</ul>
<p>经常见到的就是返回值，都是用return 1，2。第一个人写的时候知道意思，后面的人写的时候就不知道了，然后自己往上填，造成返回值冲突，判断错误。最好的是有一个枚举类型的返回值，返回的时候开发也不能随意填写，要按照枚举的类型进行返回。</p>
<ul>
<li>使用break和return而不是循环控制变量</li>
<li>将条件语句中不同部分中的重复代码合并</li>
<li>在嵌套的if语句中一旦知道结果就马上退出</li>
</ul>
<p>可以防止后面增加其他的分支或修改时，无意间破坏原有的返回值逻辑，造成返回值被意外篡改，而且对于阅读代码的人，可以很清晰的知道到这就结束了，而不用再跳来跳去，检查是否还有别的东西。</p>
<ul>
<li>去掉不用的参数</li>
<li>增加参数，而不是一个struct把参数都包括了</li>
<li>合并功能相似的子程序，用参数区分</li>
</ul>
<p>曾经也很纠结，到底如何处理类似的程序，用参数还是不同的函数名。用参数更有扩展性，而且新增功能时可以方便的进行测试。用老的测试例子就可以完成。</p>
<p>某些参数不用了，最好去掉，否则会干扰调用。一个不用的东西摆在那里，总会有人去想看看到底有没有用，浪费时间。</p>
<p>经常遇到的情况是在一个程序里有个CONFIG类参数，里面包括了要用的大部分参数。后面想把这个函数用到另外一个程序里，发现很难移植，因为要编写一个相同的类，类的成员名字也要相同，真是类死个人。最好的方法是尽量用基本的数据类型，如果类需要调用，那么把类成员展开调用就可以了。</p>
<p>我觉得，让代码好维护，就是尽量复用，不要重复。让各个逻辑模块间逻辑清晰，减少耦合。维护的时候才能只关心修改部分，不会节外生枝。</p>
<p>##安全地重构<br>留好后路，有svn、git等版本控制工具。步伐尽量小，有检测代码重构后是否逻辑有影响的监控机制。更多地测试和监控。</p>
<p>##总结</p>
<p>有些人觉得做了这些也没人看得到，而且还很麻烦，很多人也都不这么做。有句话“佛会知道”，多行善会有善报的，出来混迟早是要还的。再说了，大家都不这么做，而你这么做，不是很有优势吗？！</p>
<p>##补充<br>2013-11-11<br>上个星期主要工作是在重写一个模块，虽然我们都叫重构。由于从前都是采用同步方式进行写操作，效率不高。这次打算都作成异步的。<br>开始以为会很简单，但是工期大大超期。原因如下：</p>
<ol>
<li>从前逻辑太过于复杂，函数封装不好，重用性差。</li>
<li>边写代码边了解逻辑，没有文档。</li>
<li>迁移都协议都比较重要，但是并不是性能瓶颈，访问量不大，但迁移的风险比较大。</li>
</ol>
<p>如果时间允许的情况下，我觉得应该这样做。</p>
<ol>
<li>先在老代码上修改，封装集成函数。让开发充分了解代码逻辑，把函数抽象。</li>
<li>持续发布，利用老框架测试新代码。</li>
<li>如果没有达到瓶颈就不迁移到异步命令，保持代码整洁封装性强即可。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yunpengzhang.github.io/2013/2013-10-27-code_refactoring/" data-id="clyu70kmu003ob0ooghy51ku1" data-title="谈一谈代码重构" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/2013-11-03-reading/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          阅读心得
        
      </div>
    </a>
  
  
    <a href="/2013/2013-10-22-some_ideas/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">一些想法</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%80%9D%E8%80%83/">思考</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E5%B7%A7/">技巧</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%91%E6%AD%A5/">跑步</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">一月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">十二月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">十一月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">十月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">六月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">一月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">十二月 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">十一月 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">十月 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09/">九月 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">八月 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">七月 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">六月 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">五月 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">三月 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">二月 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/12/">十二月 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/11/">十一月 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">十月 2011</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/%E5%90%91%E7%9D%80%E7%9B%AE%E6%A0%87%E5%86%B2%E5%87%BB%E2%80%94%E2%80%94%E8%AF%BB%E3%80%8A%E6%9B%BC%E5%B7%B4%E7%B2%BE%E7%A5%9E%EF%BC%9A%E7%A7%91%E6%AF%94%E8%87%AA%E4%BC%A0%E3%80%8B%20/">向着目标冲击——读《曼巴精神：科比自传》</a>
          </li>
        
          <li>
            <a href="/2020/%E8%AE%A4%E8%AF%86%E6%80%9D%E8%80%83%E7%9A%84%E6%9C%AC%E8%B4%A8%E2%80%94%E2%80%94%E3%80%8A%E6%80%9D%E8%80%83%EF%BC%8C%E5%BF%AB%E4%B8%8E%E6%85%A2%E3%80%8B/">认识思考的本质——《思考，快与慢》</a>
          </li>
        
          <li>
            <a href="/2019/%E5%A4%9A%E9%98%B6Hash%E7%AE%97%E6%B3%95/">多阶Hash算法</a>
          </li>
        
          <li>
            <a href="/2019/%E6%A0%BC%E9%9B%B7%E7%A0%81/">格雷码</a>
          </li>
        
          <li>
            <a href="/2019/%E7%AE%80%E5%8D%95%E9%AB%98%E6%95%88%E7%9A%84%E6%8E%92%E8%A1%8C%E6%A6%9C%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84/">简单高效的排行榜算法——树状数组</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 owenzhang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>